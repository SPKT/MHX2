/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
(function(e){var b=window.PersistentStorage=function(h){this.editor=h;var g=this};b._pluginInfo={name:"PersistentStorage",version:"1.0",developer:"Douglas Mayle",developer_url:"http://douglas.mayle.org",license:"BSD"};b.prototype._backends={};b.prototype._userconfigs=[];b.prototype._activeBackend="";b.prototype._typeFilter="";b.prototype._viewType="thumbnail";b.prototype.onGenerateOnce=function(){this._prepareDialog()};function a(i,h){var g=new RegExp(" ?"+h+" ?");if(!g.test(i.className)){i.className+=" "+h}}function f(i,h){var g=new RegExp(" ?"+h+" ?");if(g.test(i.className)){i.className=i.className.replace(g," ")}}function d(i,h){var g=new RegExp(" ?"+h+" ?");if(g.test(i.className)){i.className=i.className.replace(g," ")}else{i.className+=" "+h}}b.prototype._registerDocumentUI=function(){if(this._documentEnabled){return}this._documentEnabled=true;var h=this;var g=this.editor;g.config.registerButton({id:"newdocument",tooltip:c._lc("New Document","PersistentStorage"),image:[_editor_url+g.config.imgURL+"ed_buttons_main.png",0,5],textMode:true,action:function(){h.newDocument()}});g.config.registerButton({id:"opendocument",tooltip:c._lc("Open Document","PersistentStorage"),image:[_editor_url+g.config.imgURL+"ed_buttons_main.png",1,5],textMode:true,action:function(){h.openDialog()}});g.config.registerButton({id:"savedocument",tooltip:c._lc("Save Document","PersistentStorage"),image:[_editor_url+g.config.imgURL+"ed_buttons_main.png",9,1],textMode:true,action:function(){h.saveDialog()}});g.config.addToolbarElement("newdocument","fullscreen",1);g.config.addToolbarElement("opendocument","newdocument",1);g.config.addToolbarElement("savedocument","opendocument",1);g._rebuildToolbar()};b.prototype.registerBackend=function(i,h,j,g){this._backends[i]={module:h,config:j,name:i};if(!this._activeBackend){this.setBackend(i)}if(j.capabilities.upload_operations&&j.capabilities.file_operations){this._registerDocumentUI()}if(g){this._userconfigs.push(g);this.configureUser()}this.updatePlacesDisplay()};b.prototype.configureUser=function(){var h=this;for(var i=0;i<this._userconfigs.length;++i){var j=this._userconfigs[i];for(var g in (j.plugins||{})){c.loadPlugin(g,function(){h.editor.registerPlugins([g]);c.refreshPlugin(h.editor.plugins[g].instance);h.editor._rebuildToolbar()},j.plugins[g])}}};b.prototype.newDocument=function(){if(this.editor._doc.body.lastChild){if(!confirm(c._lc("This will erase any unsaved content.  If you're certain, please click OK to continue.","PersistentStorage"))){return}}while(this.editor._doc.body.lastChild){this.editor._doc.body.removeChild(this.editor._doc.body.lastChild)}};b.prototype.saveDialog=function(){var h=this;var j=this.dialog.getElementById("h1");j.innerHTML=c._lc("Save Document","PersistentStorage");var i=this.dialog.getElementById("confirm");i.value=c._lc("Save","PersistentStorage");i.onclick=function(){h.saveDocument()};var g=this.dialog.getElementById("filename");i.disabled=g.value?false:true;g.onkeyup=g.onkeypress=g.onchange=function(){i.disabled=g.value?false:true};this.showDialog({typeFilter:["document","html","text","folder"],styleFor:"documentsave"})};b.prototype.saveDocument=function(){var g=this.editor;var h=this._backends[this._activeBackend].module;var i=this.dialog.getElementById("filename");h.saveDocument(h.viewFilter,i.value,g.getHTML(),function(){h.cache=null});this.dialog.hide()};b.prototype.openDialog=function(){var g=this;var i=this.dialog.getElementById("h1");i.innerHTML=c._lc("Open Document","PersistentStorage");var h=this.dialog.getElementById("confirm");h.value=c._lc("Open","PersistentStorage");h.onclick=function(){g.openDocument()};this.showDialog({typeFilter:["document","html","text","folder"],styleFor:"documentload"})};b.prototype.openDocument=function(){var g=this.editor;var h=this._backends[this._activeBackend].module;h.loadDocument(this.selectedEntry[0],function(i){g.setHTML(i)});this.dialog.hide()};b.prototype.showDialog=function(j){var g=this;if(!this.ready){window.setTimeout(function(){g.showDialog(j)},80);return}f(this.dialog.getElementById("WWW"),"hidden");a(this.dialog.getElementById("namefield"),"hidden");a(this.dialog.getElementById("placeWww"),"hidden");a(this.dialog.getElementById("placeBackend"),"hidden");switch(j.styleFor){case"link":f(this.dialog.getElementById("placeWww"),"hidden");this.updatePlacesDisplay("shared_publish");break;case"insertion":f(this.dialog.getElementById("placeBackend"),"hidden");this.updatePlacesDisplay("shared_publish");break;case"documentsave":a(this.dialog.getElementById("WWW"),"hidden");f(this.dialog.getElementById("namefield"),"hidden");f(this.dialog.getElementById("placeBackend"),"hidden");this.updatePlacesDisplay("file_operations");break;case"documentload":a(this.dialog.getElementById("WWW"),"hidden");f(this.dialog.getElementById("placeBackend"),"hidden");this.updatePlacesDisplay("file_operations");break}var k=this.dialog.getElementById("filters");var i=this.dialog.getElementById("fileList");this._typeFilter=j.typeFilter;var h=this._backends[this._activeBackend].module;this.updateFileBrowser()};b.prototype.displayFilters=function(g,j){var k=this.dialog.getElementById("filters");while(k.lastChild){k.removeChild(k.lastChild)}for(var i=0;i<g.length;++i){var h=document.createElement("option");h.setAttribute("value",g[i].value);if(g[i].value==j){h.setAttribute("selected","selected")}var l=document.createTextNode(g[i].display);h.appendChild(l);k.appendChild(h)}};b.prototype.buildThumbnail=function(m){var n=this;var k=this._backends[this._activeBackend].module;var l=document.createElement("div");l.entry=m;l.className="file";c._addEvent(l,"click",function(q){q=q||window.event;c._stopEvent(q);if(n.selectedEntry){f(n.selectedEntry[1],"selected");if(n.selectedEntry[1]==l){n.selectedEntry=null;return}}n.selectedEntry=[m,l];n.selectedEntry[1].className+=" selected";var p=n.dialog.getElementById("filename");p.value=m.name;var r=n.dialog.getElementById("confirm");r.disabled=false});var g=document.createElement("img");g.className="icon";if(m.$type=="image"){g.className="thumb";g.setAttribute("src",m.URL)}else{if(m.$type=="folder"){g.setAttribute("src",m.thumbURL||m.URL||this.editor.imgURL("images/tango/32x32/places/folder.png"))}else{if(m.$type=="document"){g.setAttribute("src",m.thumbURL||m.URL||this.editor.imgURL("images/tango/32x32/mimetypes/text-html.png"))}else{if(m.$type=="html"){g.setAttribute("src",m.thumbURL||m.URL||this.editor.imgURL("images/tango/32x32/mimetypes/text-html.png"))}else{if(m.$type=="txt"){g.setAttribute("src",m.thumbURL||m.URL||this.editor.imgURL("images/tango/32x32/mimetypes/text-g-generic.png"))}else{g.setAttribute("src",m.thumbURL||m.URL||this.editor.imgURL("images/tango/32x32/mimetypes/x-office-document.png"))}}}}}g=l.appendChild(g);var o=document.createElement("img");o.className="action delete";o.setAttribute("alt",c._lc("Delete","PersistentStorage"));o.setAttribute("title",c._lc("Delete","PersistentStorage"));o.setAttribute("src",this.editor.imgURL("images/tango/16x16/places/user-trash.png"));o=l.appendChild(o);c._addEvent(o,"click",function(p){p=p||window.event;c._stopEvent(p);k.deleteEntry(m,function(q){k.cache=null;if(q){l.parentNode.removeChild(l)}else{alert("Error deleting file "+m.name)}})});var h=document.createElement("p");h.className="filename";var j=document.createTextNode(m.name);j=h.appendChild(j);h=l.appendChild(h);h.onclick=function(p){return function(q){q=q||window.event;c._stopEvent(q);p.style.border="1px solid red";return false}}(h);var i=document.createElement("img");i.className="action copy";i.setAttribute("src",this.editor.imgURL("images/tango/16x16/actions/edit-copy.png"));i.setAttribute("alt",c._lc("Copy","PersistentStorage"));i.setAttribute("title",c._lc("Copy","PersistentStorage"));c._addEvent(i,"click",function(p){p=p||window.event;c._stopEvent(p);k.copyEntry(m,function(r,q){k.cache=null;if(r){l.parentNode.appendChild(n.buildThumbnail(q))}else{alert("Error copying file "+m.name)}})});i=l.appendChild(i);return l};b.prototype.displayBrowser=function(k){var m=this.dialog.getElementById("fileList");while(m.lastChild){m.removeChild(m.lastChild)}var i=this.editor;var h=this;for(var j=0;j<k.length;++j){switch(this._viewType){case"listing":break;case"thumbnail":default:var g=m.appendChild(this.buildThumbnail(k[j]));if(e&&e.ui&&e.ui.draggable&&e.ui.droppable){e(g).draggable({revert:true});if(k[j].$type=="folder"){e(g).droppable({accept:"*",drop:function(o,n){var p=this;n.draggable.each(function(){var r=this;var s=r.entry;var q=h._backends[h._activeBackend].module;q.moveEntry(s,p.entry,function(t){q.cache=null;if(t){r.parentNode.removeChild(r)}else{alert("Error deleting file "+s.name)}})})}})}}}}if(!m.firstChild){var l=document.createTextNode("No files found");m.appendChild(l)}};b.prototype.updateFileBrowser=function(){var g=this;var h=this._backends[this._activeBackend].module;var i=function(l){h.cache=l;var j=h.getFilters(h.cache);var k=true;if(h.viewFilter){for(var n=0;n<j.length;++n){if(j[n].value==h.viewFilter){k=false}}}if(k){h.viewFilter=j[0].value}var m=h.getMetadata(h.cache,h.viewFilter,g._typeFilter);g.dialog.show();g.displayFilters(j,h.viewFilter);g.displayBrowser(m)};if(h.cache){i(h.cache);return}h.loadData(i)};b.prototype._prepareDialog=function(){var j=this;var i=this.editor;if(!this.html){c._getback(c.getPluginDir("PersistentStorage")+"/dialog.html",function(o){j.html=o;j._prepareDialog()});return}this.dialog=new c.Dialog(i,this.html,"PersistentStorage",{width:800,closeOnEscape:true,resizable:true,centered:true,modal:true});this.dialog.getElementById("cancel").onclick=function(){j.dialog.hide()};this.dialog.getElementById("dirCreate").onclick=function(){var p=prompt(c._lc("Please enter the name of the directory you'd like to create.","PersistentStorage"));if(p){var o=j._backends[j._activeBackend].module;o.makeFolder(o.viewFilter,p,function(q){if(q){o.cache=null;j.updateFileBrowser()}})}};var n=this.dialog.getElementById("importlegend");var h=this.dialog.getElementById("import");n.onclick=function(){d(h,"collapsed")};var m=this.dialog.getElementById("WWW");c._addEvent(m,"click",function(p){p=p||window.event;c._stopEvent(p);for(var o=m.parentNode.firstChild;o;o=o.nextSibling){if(1!=o.nodeType){continue}f(o,"selected")}a(m,"selected");a(j.dialog.getElementById("placeBackend"),"hidden");f(j.dialog.getElementById("placeWww"),"hidden")});var l=this.dialog.getElementById("fileList");c._addEvent(l,"click",function(p){for(var o=l.firstChild;o;o=o.nextSibling){f(o,"selected")}});var k=this.dialog.getElementById("filters");k.onchange=function(){var o=j._backends[j._activeBackend].module;o.viewFilter=k.options[k.selectedIndex].value;j.updateFileBrowser()};var g=this.dialog.getElementById("viewType");g.onchange=function(){j._viewType=g.options[g.selectedIndex].value;j.updateFileBrowser()};this.ready=true};b.prototype.updatePlacesDisplay=function(k){var j=this;var l=this.dialog.getElementById("placesList");while(l.firstChild&&3==l.firstChild.nodeType){l.removeChild(l.firstChild)}var i=l.firstChild;while(i.nextSibling){l.removeChild(i.nextSibling)}for(var g in this._backends){if(k&&!this._backends[g].config.capabilities[k]){continue}var h=l.appendChild(this.placesIcon(this._backends[g]));if(e&&e.ui&&e.ui.draggable&&e.ui.droppable){e(h).droppable({accept:"*",drop:function(n,m){var o=this;m.draggable.each(function(){var q=this;var r=q.entry;var p=j._backends[j._activeBackend].module;p.loadDocument(r,function(s){o.backend.module.saveDocument(p.viewFilter,r.name,s,function(){o.backend.module.cache=null;p.deleteEntry(r,function(t){p.cache=null;if(t){q.parentNode.removeChild(q)}else{alert("Error deleting file "+r.name)}})})})})}})}}};b.prototype.setBackend=function(g){if(this._activeBackend==g){return}this._activeBackend=g;var i=this._backends[this._activeBackend];if(i.config.capabilities.import_operations){c._removeClass(this.dialog.getElementById("import"),"hidden");var h=this.dialog.getElementById("importui");while(h.firstChild){h.removeChild(h.firstChild)}i.module.buildImportUI(this.dialog,h)}else{c._addClass(this.dialog.getElementById("import"),"hidden")}};b.prototype.placesIcon=function(j){var h=this;var k=document.createElement("div");k.backend=j;k.className="file";if(this._activeBackend==j.name){k.className+=" selected"}c._addEvent(k,"click",function(n){n=n||window.event;c._stopEvent(n);for(var m=k.parentNode.firstChild;m;m=m.nextSibling){if(1!=m.nodeType){continue}f(m,"selected")}a(k,"selected");f(h.dialog.getElementById("placeBackend"),"hidden");a(h.dialog.getElementById("placeWww"),"hidden");h.setBackend(j.name);h.updateFileBrowser()});var l=document.createElement("img");l.className="icon";l.setAttribute("src",j.config.thumbURL||this.editor.imgURL("images/tango/32x32/places/network-server.png"));l=k.appendChild(l);var i=document.createElement("p");i.className="filename";var g=document.createTextNode(j.config.displayName||j.name);g=i.appendChild(g);i=k.appendChild(i);return k};var c=window.Xinha;c.prototype._insertImage=function(i){var g=this;var k=g.plugins.PersistentStorage.instance;var j=k.dialog.getElementById("h1");j.innerHTML=c._lc("Insert Image","PersistentStorage");var h=k.dialog.getElementById("confirm");h.value=c._lc("Insert","PersistentStorage");h.onclick=function(){k.insertImage()};k.showDialog({typeFilter:["image","folder"],styleFor:"insertion"})};b.prototype.insertImage=function(){var h=this.editor;this.dialog.hide();var i=h._doc.createElement("img");if(this.selectedEntry){i.setAttribute("src",this.selectedEntry[0].URL)}else{i.setAttribute("src",this.dialog.getElementById("URL").value)}for(var k in {width:"",height:"",margin:"",padding:"",border:"",borderColor:"",backgroundColor:""}){var j=this.dialog.getElementById("image_"+k).value.replace(/^\s+$/,"");if(j){i.style[k]=j}}h.insertNodeAtSelection(i);var g=h.createRange(h.getSelection());g.collapse(false)}})(window.jQuery);