/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
function InsertNote(c){this.editor=c;var a=c.config;var b=this;a.registerButton({id:"insert-note",tooltip:this._lc("Insert footnote"),image:c.imgURL("insert-note.gif","InsertNote"),textMode:false,action:function(){b.show()}});a.addToolbarElement("insert-note","createlink",1)}InsertNote._pluginInfo={name:"InsertNote",version:"0.4",developer:"Nicholas Bergson-Shilcock",developer_url:"http://www.nicholasbs.com",c_owner:"Nicholas Bergson-Shilcock",sponsor:"The Open Planning Project",sponsor_url:"http://topp.openplans.org",license:"LGPL"};InsertNote.prototype.onGenerateOnce=function(){this.notes={};this.noteNums={};this.ID_PREFIX="InsertNoteID_";this.MARKER_SUFFIX="_marker";this.MARKER_CLASS="InsertNoteMarker";this.LINK_BACK_SUFFIX="_LinkBacks";this.NOTE_LIST_ID="InsertNote_NoteList";this._prepareDialog()};InsertNote.prototype._prepareDialog=function(){var b=this;var a=this.editor;if(!this.html){Xinha._getback(Xinha.getPluginDir("InsertNote")+"/dialog.html",function(c){b.html=c;b._prepareDialog()});return}this.dialog=new Xinha.Dialog(a,this.html,"InsertNote",{width:400,closeOnEscape:true,resizable:false,centered:true,modal:true});this.dialog.getElementById("ok").onclick=function(){b.apply()};this.dialog.getElementById("cancel").onclick=function(){b.dialog.hide()};this.dialog.getElementById("noteMenu").onchange=function(){var c=this.options[this.selectedIndex].value;var e=b.notes[c]||"";var d=b.dialog.getElementById("noteContent");d.value=e;if(e){d.disabled=true}else{d.disabled=false;d.focus()}};this.ready=true};InsertNote.prototype.show=function(){if(!this.ready){var j=this;window.setTimeout(function(){j.show()},80);return}var a=this.editor;var g=document;this.repairNotes();if(this.cursorInFootnote()){alert("Footnotes cannot be inserted inside of other footnotes.");return}this.dialog.show();var f=this.dialog.getElementById("noteMenu");while(f.lastChild.value!="new"){f.removeChild(f.lastChild)}var h,e,b;var k=this._getOrderedNoteIds();for(var c=0;c<k.length;c++){b=k[c];h=g.createElement("option");h.setAttribute("value",b);e=this.notes[b];e=e.replace(/<[^>]*>/gi,"");if(e.length>50){e=e.substr(0,50)+"..."}e=this._getNumFromNoteId(b)+". "+e;h.appendChild(g.createTextNode(e));f.appendChild(h)}var d=this.dialog.getElementById("noteContent");d.disabled=false;d.focus();d.value=""};InsertNote.prototype.cursorInFootnote=function(b){var a=this.editor.getAllAncestors();for(var c=0;c<a.length;c++){if(a[c].id==this.NOTE_LIST_ID){return true}if(a[c].className==this.MARKER_CLASS&&!b){return true}}return false};InsertNote.prototype.repairNotes=function(){var m=this;var j;var d;var c;var f;var l;var k=this.editor._doc;this.repairScheduled=false;d=this._getMarkers();for(var e=0;e<d.length;e++){c=d[e];f=false;if(c){f=c.innerHTML.match(/^(<span[^>]*>)?(<sup>)?(<a[^>]*>)?[\s]*(<\/a>)?(<\/sup>)?(<\/span>)?$/m)}if(f){c.parentNode.removeChild(c)}var h=this._getIdFromMarkerId(c.id);if(!this.notes[h]){j=k.getElementById(h);if(j){this._saveNote(j)}else{if(c){c.parentNode.removeChild(c)}}}}for(var a in this.notes){j=k.getElementById(a);d=this._getMarkers(a);if(j){if(d.length==0){j.parentNode.removeChild(j);delete this.notes[a]}else{this._saveNote(j)}}else{for(var e=0;e<d.length;e++){d[e].parentNode.removeChild(d[e])}delete this.notes[a]}}this._updateRefNums();var b=k.getElementById(this.NOTE_LIST_ID);var g=this._createNoteList();if(g){b.parentNode.replaceChild(g,b)}else{if(b){b.parentNode.removeChild(b)}}};InsertNote.prototype._saveNote=function(c){var d=this.editor._doc;var a=d.getElementById(this._getLinkBackSpanId(c.id));if(a){a.parentNode.removeChild(a)}if(c.innerHTML){this.notes[c.id]=c.innerHTML}else{delete this.notes[c.id];markers=this._getMarkers(c.id);for(var b=0;b<markers.length;b++){markers[b].parentNode.removeChild(markers[b])}}};InsertNote.prototype._updateRefNums=function(){var a=1;var c;var e;var b;this.noteNums={};var f=this._getMarkers();for(var d=0;d<f.length;d++){e=f[d];b=this._getIdFromMarkerId(e.id);if(this.noteNums[b]){c=this.noteNums[b]}else{this.noteNums[b]=a;c=a++}e.firstChild.firstChild.innerHTML=c}};InsertNote.prototype.apply=function(){var b=this.editor;var d=this.dialog.hide();var i=d.noteMenu.value;var c=(i=="new");var h=d.noteContent;var l=b._doc;if(c){i=this._getNextId(this.ID_PREFIX)}this.notes[i]=h;var k=this._createNoteMarker(i);b.insertNodeAtSelection(k);var e=l.getElementById(k.id);var j=l.getElementById(this.NOTE_LIST_ID);var g=this._createNoteList();var f=l.body;if(j){f.replaceChild(g,j)}else{f.appendChild(g)}var a=l.createTextNode("\u00a0");if(e.nextSibling){a=e.parentNode.insertBefore(a,e.nextSibling)}else{a=e.parentNode.appendChild(a)}this.repairNotes();b.selectNodeContents(a,false)};InsertNote.prototype._createNoteList=function(){var d=this.editor._doc;var e=d.createElement("ol");e.id=this.NOTE_LIST_ID;var c=this._getOrderedNoteIds();if(c.length==0){return null}var b,f;for(var a=0;a<c.length;a++){f=c[a];b=this._createNoteNode(f,this.notes[f]);e.appendChild(b)}return e};InsertNote.prototype._createNoteMarker=function(b){var e=this.editor._doc;var f=this._getNumFromNoteId(b);var d=e.createElement("a");d.href="#"+b;d.innerHTML=f;var a=e.createElement("sup");a.appendChild(d);var c=e.createElement("span");c.id=this._getNextMarkerId(b);c.className=this.MARKER_CLASS;c.appendChild(a);return c};InsertNote.prototype._createNoteNode=function(e,d){var h=this.editor._doc;var a;var g=h.createElement("sup");var b=this._getMarkers(e);var k;for(var c=0;c<b.length;c++){a=h.createElement("a");if(b.length==1){a.innerHTML="^"}else{a.innerHTML=this._letterNum(c)}a.href="#"+b[c].id;g.appendChild(a);if(c<b.length-1){k=h.createTextNode(", ");g.appendChild(k)}}var f=h.createElement("span");f.id=this._getLinkBackSpanId(e);f.appendChild(g);var j=h.createElement("li");j.id=e;j.innerHTML=d;j.appendChild(f);return j};InsertNote.prototype._getNextId=function(a){var b=Xinha.uniq(a);while(this.editor._doc.getElementById(b)){b=Xinha.uniq(a)}return b};InsertNote.prototype._getOrderedNoteIds=function(){var a=this;var b=new Array();for(var c in this.notes){b.push(c)}b.sort(function(e,d){var g=a._getNumFromNoteId(e);var f=a._getNumFromNoteId(d);return(g-f)});return b};InsertNote.prototype._getNumFromNoteId=function(a){if(!this.noteNums[a]){return 0}return this.noteNums[a]};InsertNote.prototype._getMarkers=function(a){var d=this.editor._doc;var e=Xinha.getElementsByClassName(d,this.MARKER_CLASS);if(!a){return e}var c=new Array();for(var b=0;b<e.length;b++){if(this._getIdFromMarkerId(e[b].id)==a){c.push(e[b])}}return c};InsertNote.prototype._getNextMarkerId=function(a){return this._getNextId(a+this.MARKER_SUFFIX)};InsertNote.prototype._getIdFromMarkerId=function(a){return a.substr(0,a.search(this.MARKER_SUFFIX))};InsertNote.prototype._getLinkBackSpanId=function(a){return a+this.LINK_BACK_SUFFIX};InsertNote.prototype._lc=function(a){return Xinha._lc(a,"InsertNote")};InsertNote.prototype._letterNum=function(b){var e="abcdefghijklmnopqrstuvwxyz";var a=Math.floor(b/e.length)+1;var d="";for(var c=0;c<a;c++){d+=e.substr(b%e.length,1)}return d};InsertNote.prototype.inwardHtml=function(a){return a};InsertNote.prototype.outwardHtml=function(a){this.repairNotes();return this.editor.getHTML()};InsertNote.prototype.onKeyPress=function(b){if(b.keyCode==8||b.keyCode==46){var a=this;if(!this.repairScheduled&&!this.cursorInFootnote(true)){this.repairScheduled=true;window.setTimeout(function(){a.repairNotes()},1000)}}return false};InsertNote.prototype.onMode=function(a){return false};InsertNote.prototype.onBeforeMode=function(a){return false};